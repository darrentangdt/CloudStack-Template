#!/bin/bash
#
# Flush all things not needed for a new VM and create default network environment
#
# chkconfig: 235 90 02
# description: Prepare new VM
### BEGIN INIT INFO
# Provides:          firstboot-cloudstack
# Required-Start:    $network $local_fs $remote_fs $syslog $all
# Required-Stop:     $network $local_fs $remote_fs $syslog $all
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Prepare new VM
# Description:       Prepare new VM by flushing old information and preparing network environment
### END INIT INFO

function find_lease() {
  # Determine primary network adapter name
  NIC=`ip link | grep UP | grep -v LOOPBACK | awk -F':' '{print $2}' | tr -d ' '`

  # Add your DHCP lease folders here
  if [ -f /etc/debian_version ]; then
    # Ubuntu
    #DHCP_FOLDERS="/var/lib/dhcpcd/dhcpcd-eth0.*"
    DHCP_FOLDERS="/var/lib/dhclient/*$NIC* /var/lib/dhcp3/*$NIC* /var/lib/dhcp/*$NIC*"
  elif [ -f /etc/redhat-release ]; then
    # Redhat / CentOS / Scientific Linux
    DHCP_FOLDERS="/var/lib/dhclient/*$NIC* /var/lib/dhcp3/*$NIC*"
  else
    # Others
    DHCP_FOLDERS="/var/lib/dhclient/*$NIC* /var/lib/dhcp3/*$NIC*"
  fi

  DHCLIENT=$(which dhclient)
  RESTART_DHCLIENT=true
  for DHCP_FILE in $DHCP_FOLDERS; do
    if [ -f $DHCP_FILE ]; then
        LEASE_FILE=$DHCP_FILE
        logger -t "cloud" "DHCP file ($LEASE_FILE) exists. No need to restart dhclient."
        RESTART_DHCLIENT=false
    fi
  done

  if [ $RESTART_DHCLIENT = true ]; then
    logger -t "cloud" "DHCP file does not exist. Restarting dhclient."
    DHCLIENT_PID=$(ps ax | grep dhclient | awk {'print $1'})
    if [ -n $DHCLIENT_PID ]; then
          for CLIENTPID in $DHCLIENT_PID; do
            kill $CLIENTPID
          done
    fi
    $DHCLIENT
    find_lease
  fi
}


echo "Initializing Virtual Machine..."
logger -t "Setup" "Initializing Virtual Machine..."

find_lease

HOST_NAME=`grep host-name $LEASE_FILE | awk '{print $NF}' | tr -d '\;' | tr -d '"' | uniq`
echo "Setting hostname to $HOST_NAME" 
logger -t "Setup" "Setting hostname to $HOST_NAME"
echo $HOST_NAME > /etc/hostname
/bin/hostname $HOST_NAME

echo "# Do not remove the following line, or various programs" > /etc/hosts
echo "# that require network functionality will fail." >> /etc/hosts
echo "127.0.0.1       localhost.localdomain localhost" >> /etc/hosts
echo "# The following lines are desirable for IPv6 capable hosts" >> /etc/hosts
echo "::1             ip6-localhost ip6-loopback" >> /etc/hosts
echo "fe00::0         ip6-localnet" >> /etc/hosts
echo "ff00::0         ip6-mcastprefix" >> /etc/hosts
echo "ff02::1         ip6-allnodes" >> /etc/hosts
echo "ff02::2         ip6-allrouters" >> /etc/hosts
echo "::1             localhost6.localdomain6 localhost6" >> /etc/hosts
IP=`grep fixed-address $LEASE_FILE | awk '{print $NF}' | tr -d '\;' | uniq`
echo "Setting up /etc/hosts for IP address $IP" 
logger -t "Setup" "Setting up /etc/hosts for IP address $IP"
echo "$IP      $HOST_NAME" >> /etc/hosts

/usr/bin/yum clean all

chkconfig firstboot-cloudstack off

if [ -f /usr/bin/systemd-run ]
  then
    systemctl disable firstboot-cloudstack
  fi
